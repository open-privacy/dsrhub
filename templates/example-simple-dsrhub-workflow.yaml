name: example-simple-dsrhub-workflow
title_format: example simple dsrhub workflow
description: example simple dsrhub workflow
auto_runnable: true

inputs:
- name: identity_type
  description: Identity Type
  default: email
- name: identity_format
  description: Identity Format
  default: raw
- name: identity_value
  description: Identity Value
  default: zzzz@example.com

steps:
  get_time:
    description: Get UTC time
    action:
      type: http
      configuration:
        url: http://worldclockapi.com/api/json/utc/now
        method: GET
  get_user:
    description: Get user
    dependencies: ["get_time"]
    custom_states: [NOT_FOUND]
    action:
      type: http
      configuration:
        url: http://openmock:9999/users/not_found
        method: GET
    conditions:
    - type: check
      if:
      - value: '{{.step.get_user.metadata.HTTPStatus}}'
        operator: EQ
        expected: '404'
      then:
        this: NOT_FOUND
      message: 'User {{.input.identity_value}} not found'
  createUser:
    description: Create the user
    dependencies: ["get_user:NOT_FOUND"]
    action:
      type: http
      configuration:
        url: http://openmock:9999/users
        method: POST
        body: |-
          {"email":"{{.input.identity_value}}"}
  get_user_copy:
    description: Get user
    dependencies: ["get_time"]
    custom_states: [NOT_FOUND]
    action:
      type: http
      configuration:
        url: http://openmock:9999/users/not_found
        method: GET
    conditions:
    - type: check
      if:
      - value: '{{.step.get_user_copy.metadata.HTTPStatus}}'
        operator: EQ
        expected: '404'
      then:
        this: NOT_FOUND
      message: 'User {{.input.identity_value}} not found'
  create_user_copy:
    description: Create the user
    dependencies: ["get_user_copy:NOT_FOUND"]
    action:
      type: http
      configuration:
        url: http://openmock:9999/users
        method: POST
        body: |-
          {"email":"{{.input.identity_value}}"}

  resolve_email_to_candidate_id:
    description: Map email to candidate_id
    dependencies: ["get_time"]
    action:
      type: http
      configuration:
        url: http://openmock:9999/users/found
        method: GET

  microservice_a_delete:
    description: Delete candidate_id from service A
    dependencies: ["resolve_email_to_candidate_id"]
    action:
      type: http
      configuration:
        url: http://openmock:9999/service_a/users/candidate_id/{{.step.resolve_email_to_candidate_id.output.candidate_id}}
        method: DELETE

  microservice_a_done:
    description: notify service B deletion
    dependencies: ["microservice_a_delete"]
    action:
      type: echo
      configuration:
        output:
          hello: world

  microservice_b_delete:
    description: Delete email from service B
    dependencies: ["get_time"]
    action:
      type: http
      configuration:
        url: 'http://openmock:9999/service_b/users/email/{{.input.identity_value}}'
        method: DELETE
        body: 'http://utask:8081/resolution/{{.task.resolution_id}}/microservice_b_callback'
        headers:
        - name: x-callback-url
          value: 'http://utask:8081/dsrhub/callback/{{.task.resolution_id}}/microservice_b_callback'
  microservice_b_callback:
    description: Wait for service B callback
    dependencies: ["get_time", "microservice_b_delete"]
    action:
      type: echo
      configuration:
        output:
          metadata: '{{field "resolver_input" "microservice_b_callback" "request_status"}}'
    conditions:
    - type: check
      if:
      - value: '{{field "resolver_input" "microservice_b_callback" "request_status"}}'
        operator: NE
        expected: 'done'
      then:
        this: TO_RETRY
      message: 'service B is pending'
  microservice_b_done:
    description: notify service B deletion
    dependencies: ["microservice_b_callback"]
    action:
      type: echo
      configuration:
        output:
          hello: world
